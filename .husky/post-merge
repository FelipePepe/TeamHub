#!/bin/sh
set -e

ROOT_DIR="$(git rev-parse --show-toplevel)"
current_branch=$(git symbolic-ref --short HEAD 2>/dev/null)

# ============================================================================
# SonarQube Analysis - only on develop branch
# ============================================================================
# Runs automatically after git pull on develop (post-merge)
# Generates coverage reports and sends them to local SonarQube
# ============================================================================

if [ "$current_branch" != "develop" ]; then
  exit 0
fi

echo ""
echo "ğŸ“Š SonarQube: Generating coverage reports and analyzing develop..."
echo ""

# Load SonarQube credentials
if [ ! -f "$ROOT_DIR/.env.sonar" ]; then
  echo "âš ï¸  Skipping SonarQube: .env.sonar not found"
  echo "   Copy .env.sonar.example to .env.sonar and configure your token"
  exit 0
fi

export $(grep -v '^#' "$ROOT_DIR/.env.sonar" | grep -v '^\s*$' | xargs)

if [ -z "$SONAR_TOKEN" ]; then
  echo "âš ï¸  Skipping SonarQube: SONAR_TOKEN not set in .env.sonar"
  exit 0
fi

# Check if SonarQube is reachable
if ! curl -s --max-time 3 "http://localhost:9000/api/system/status" > /dev/null 2>&1; then
  echo "âš ï¸  Skipping SonarQube: server not reachable at localhost:9000"
  exit 0
fi

# Generate coverage - backend
echo "ğŸ§ª Backend: running tests with coverage..."
if (cd "$ROOT_DIR/backend" && npx vitest run --coverage 2>&1 | tail -5); then
  echo "âœ… Backend coverage generated"
else
  echo "âš ï¸  Backend tests had failures (coverage still generated)"
fi

# Generate coverage - frontend
echo ""
echo "ğŸ§ª Frontend: running tests with coverage..."
if (cd "$ROOT_DIR/frontend" && npx vitest run --coverage 2>&1 | tail -5); then
  echo "âœ… Frontend coverage generated"
else
  echo "âš ï¸  Frontend tests had failures (coverage still generated)"
fi

# Run SonarQube analysis for develop project
echo ""
echo "ğŸ“¡ Sending analysis to SonarQube (TeamHub-develop)..."
(cd "$ROOT_DIR" && npx sonar-scanner \
  -Dsonar.token="$SONAR_TOKEN" \
  -Dsonar.projectKey=TeamHub-develop \
  -Dsonar.projectName="TeamHub (develop)" 2>&1 | tail -5)

echo ""
echo "âœ… SonarQube analysis complete"
echo "ğŸŒ Results: http://localhost:9000/dashboard?id=TeamHub-develop"
